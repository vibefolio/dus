<% content_for :title, "마이페이지 - 디어스" %>

<div class="container" style="padding-top: 40px; padding-bottom: 80px;">
  <!-- Profile Header -->
  <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 40px; padding-bottom: 30px; border-bottom: 1px solid #eee;">
    <div style="width: 80px; height: 80px; background: #e5e7eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden;">
      <% if current_user.image.present? %>
        <img src="<%= current_user.image %>" alt="Profile" style="width: 100%; height: 100%; object-fit: cover;">
      <% else %>
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <% end %>
    </div>
    <div>
      <h1 style="font-size: 24px; font-weight: 800; margin-bottom: 4px;"><%= current_user.name || current_user.email.split('@')[0] %>님, 환영합니다!</h1>
      <p style="color: #666; font-size: 14px;"><%= current_user.email %></p>
    </div>
  </div>

  <!-- Tabs Navigation -->
  <div style="display: flex; gap: 10px; margin-bottom: 30px;">
    <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-btn active">대시보드</button>
    <button onclick="switchTab('orders')" id="tab-orders" class="tab-btn">구매 내역</button>
    <button onclick="switchTab('wishlist')" id="tab-wishlist" class="tab-btn">위시리스트</button>
  </div>

  <!-- Tab Contents -->
  
  <!-- 1. Dashboard -->
  <div id="content-dashboard" class="tab-content" style="display: block;">
    <div class="grid grid-2" style="gap: 20px;">
      <!-- My Website Status -->
      <div class="card" style="padding: 30px;">
        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 20px;">내 홈페이지 현황</h3>
        <% if @my_websites.any? %>
          <!-- Website List (Placeholder) -->
        <% else %>
          <div style="text-align: center; padding: 30px 0; color: #888;">
            <p style="margin-bottom: 15px;">제작 중인 홈페이지가 없습니다.</p>
            <%= link_to "템플릿 둘러보기", design_templates_path, class: "btn btn-sm btn-primary" %>
          </div>
        <% end %>
      </div>

      <!-- Recent Orders Summary -->
      <div class="card" style="padding: 30px;">
        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 20px;">최근 구매 내역</h3>
        <% if @orders.any? %>
          <ul style="list-style: none; padding: 0;">
            <% @orders.take(3).each do |order| %>
              <li style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f3f4f6;">
                <span><%= order.product.try(:name) || "상품정보 없음" %></span>
                <span style="font-weight: 600;"><%= number_to_currency(order.amount, unit: "원", format: "%n%u", precision: 0) %></span>
              </li>
            <% end %>
          </ul>
        <% else %>
          <p style="color: #888;">최근 구매 내역이 없습니다.</p>
        <% end %>
      </div>
    </div>
  </div>

  <!-- 2. Orders -->
  <div id="content-orders" class="tab-content" style="display: none;">
    <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 20px;">전체 구매 내역</h2>
    <% if @orders.any? %>
      <div style="background: white; border-radius: 12px; border: 1px solid #eee; overflow: hidden;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead style="background: #f9fafb; border-bottom: 1px solid #eee;">
            <tr>
              <th style="padding: 15px; text-align: left; font-size: 14px; font-weight: 600; color: #666;">주문번호</th>
              <th style="padding: 15px; text-align: left; font-size: 14px; font-weight: 600; color: #666;">상품명</th>
              <th style="padding: 15px; text-align: left; font-size: 14px; font-weight: 600; color: #666;">결제금액</th>
              <th style="padding: 15px; text-align: left; font-size: 14px; font-weight: 600; color: #666;">상태</th>
              <th style="padding: 15px; text-align: left; font-size: 14px; font-weight: 600; color: #666;">날짜</th>
            </tr>
          </thead>
          <tbody>
            <% @orders.each do |order| %>
              <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 15px; font-size: 14px;"><%= order.order_uid %></td>
                <td style="padding: 15px; font-weight: 600;"><%= order.product.try(:name) %></td>
                <td style="padding: 15px;"><%= number_to_currency(order.amount, unit: "원", format: "%n%u", precision: 0) %></td>
                <td style="padding: 15px;">
                  <span style="padding: 4px 8px; border-radius: 99px; font-size: 12px; font-weight: 600; background: #ecfdf5; color: #047857;">
                    <%= order.status %>
                  </span>
                </td>
                <td style="padding: 15px; color: #666; font-size: 13px;"><%= order.created_at.strftime("%Y-%m-%d") %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div style="text-align: center; padding: 60px 0; background: #f9fafb; border-radius: 12px; color: #888;">
        구매 내역이 없습니다.
      </div>
    <% end %>
  </div>

  <!-- 3. Wishlist -->
  <div id="content-wishlist" class="tab-content" style="display: none;">
    <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 20px;">위시리스트</h2>
    
    <% if @liked_templates.any? %>
      <div class="grid grid-3" style="gap: 20px;">
        <% @liked_templates.each do |template| %>
          <div class="card" style="padding: 0; overflow: hidden; position: relative;">
            <div style="height: 200px; background: #f3f4f6;">
              <img src="<%= template.pc_thumbnail_url %>" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            <div style="padding: 20px;">
               <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 4px;"><%= template.title %></h3>
               <p style="color: #666; font-size: 13px; margin-bottom: 15px;"><%= template.category %></p>
               
               <div style="display: flex; gap: 10px;">
                 <%= link_to "상세보기", "#", class: "btn btn-sm btn-outline", style: "flex: 1; text-align: center;" %>
                 <!-- 하트 취소 버튼 (Optional) -->
                 <%= button_to design_template_toggle_like_path(template), method: :post, class: "btn btn-sm", style: "background: #fee2e2; color: #ef4444; border: none;" do %>
                   ♥
                 <% end %>
               </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div style="text-align: center; padding: 60px 0; background: #f9fafb; border-radius: 12px; color: #888;">
        <p style="font-size: 16px; margin-bottom: 15px;">찜한 템플릿이 없습니다.</p>
        <%= link_to "템플릿 구경가기", design_templates_path, class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>

</div>

<style>
  .tab-btn {
    padding: 10px 20px;
    background: transparent;
    border: none;
    font-size: 16px;
    font-weight: 600;
    color: #6b7280;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
  }
  .tab-btn.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
  }
  .tab-btn:hover:not(.active) {
    color: #374151;
  }
</style>

<script>
  function switchTab(tabName) {
    // Hide all
    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

    // Show target
    document.getElementById(`content-${tabName}`).style.display = 'block';
    document.getElementById(`tab-${tabName}`).classList.add('active');
  }
</script>
