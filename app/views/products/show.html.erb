<% content_for :title, @product.name %>

<!-- Toss Payments SDK -->
<script src="https://js.tosspayments.com/v1/payment"></script>

<div class="max-w-4xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
  <% if notice.present? %>
    <div class="bg-green-50 border-1 border-green-200 text-green-700 px-4 py-3 rounded relative mb-6" role="alert">
      <span class="block sm:inline"><%= notice %></span>
    </div>
  <% end %>

  <% if alert.present? %>
    <div class="bg-red-50 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
      <p class="font-bold">Error</p>
      <p><%= alert %></p>
    </div>
  <% end %>

  <div class="lg:grid lg:grid-cols-2 lg:gap-x-8 lg:items-start">
    <!-- Image Gallery -->
    <div class="flex flex-col">
      <div class="w-full aspect-w-1 aspect-h-1 bg-gray-200 rounded-lg overflow-hidden xl:aspect-w-7 xl:aspect-h-8">
        <% if @product.image_url.present? %>
          <img src="<%= @product.image_url %>" alt="<%= @product.name %>" class="w-full h-full object-center object-cover group-hover:opacity-75">
        <% else %>
          <div class="w-full h-96 flex items-center justify-center text-gray-400 bg-gray-100">
            <span>No image available</span>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Product Info -->
    <div class="mt-10 px-4 sm:px-0 sm:mt-16 lg:mt-0">
      <h1 class="text-3xl font-extrabold tracking-tight text-gray-900"><%= @product.name %></h1>
      
      <div class="mt-3">
        <h2 class="sr-only">Product information</h2>
        <p class="text-3xl text-gray-900"><%= number_to_currency(@product.price, unit: "₩", precision: 0, format: "%u%n") %></p>
      </div>

      <div class="mt-6">
        <h3 class="sr-only">Description</h3> 
        <div class="text-base text-gray-700 space-y-6">
          <p><%= @product.description %></p>
        </div>
      </div>
      
      <div class="mt-6">
        <div class="flex items-center">
            <span class="mr-2 text-sm font-medium text-gray-500">재고:</span>
            <span class="text-sm font-medium text-gray-900"><%= @product.stock %>개</span>
        </div>
      </div>

      <!-- Actions -->
      <div class="mt-10 flex sm:flex-col1">
        <button id="payment-button" class="w-full bg-indigo-600 border border-transparent rounded-md py-3 px-8 flex items-center justify-center text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 cursor-pointer shadow-lg transform transition hover:scale-105">
          구매하기 (Toss 결제)
        </button>
      </div>
      
      <!-- Admin Actions -->
      <div class="mt-8 border-t border-gray-200 pt-6">
        <div class="flex space-x-4 text-sm justify-center">
            <%= link_to "상품 수정", edit_product_path(@product), class: "text-indigo-600 hover:text-indigo-500 font-medium" %>
            <span class="text-gray-300">|</span>
            <%= link_to "목록으로", products_path, class: "text-gray-500 hover:text-gray-400 font-medium" %>
            <span class="text-gray-300">|</span>
            <%= button_to "상품 삭제", @product, method: :delete, class: "text-red-600 hover:text-red-500 font-medium bg-transparent border-none cursor-pointer p-0", data: { turbo_confirm: "정말 삭제하시겠습니까?" } %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const clientKey = 'test_ck_D5GePWvyJnrK0W0k6q8gLzN97Eoq'; // 테스트용 클라이언트 키
  const tossPayments = TossPayments(clientKey);

  document.getElementById('payment-button').addEventListener('click', function () {
    const orderId = 'ORDER-' + new Date().getTime(); // 임시 주문 번호

    tossPayments.requestPayment('카드', {
      amount: <%= @product.price %>,
      orderId: orderId,
      orderName: '<%= @product.name %>',
      customerName: 'Customer', 
      successUrl: window.location.origin + '/orders/success?product_id=<%= @product.id %>',
      failUrl: window.location.origin + '/orders/fail',
    })
    .catch(function (error) {
      if (error.code === 'USER_CANCEL') {
        // 결제 취소
      } else if (error.code === 'INVALID_CARD_COMPANY') {
        // 카드 에러
      }
    });
  });
</script>
