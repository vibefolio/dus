<%# 
  PURE DB-DRIVEN DESIGN TEMPLATES PAGE 
  No hardcoded data. What you see is what's in the DB.
%>

<div class="bg-slate-50 min-h-screen pt-24 pb-20 font-sans">
  
  <!-- Header Filter Section -->


  <!-- Main Grid -->
  <div class="max-w-7xl mx-auto px-4 md:px-6 py-12">
    
    <!-- Filter Section (Moved here) -->
    <div class="mb-12">
      <form action="<%= design_templates_path %>" method="get" class="flex flex-col xl:flex-row gap-6 items-start xl:items-center justify-between">
        
        <!-- Category Buttons -->
        <div class="flex flex-wrap gap-2 w-full xl:flex-1">
          <% 
            categories = [
              ['all', 'ì „ì²´'],
              ['beauty', 'ë·°í‹°'],
              ['dining', 'ë‹¤ì´ë‹'],
              ['corporate', 'ê¸°ì—… Â· ìŠ¤íƒ€íŠ¸ì—…'],
              ['medical', 'ë³‘ì› Â· ë²•ë¥ '],
              ['fitness', 'ìš´ë™ Â· í—¬ìŠ¤'],
              ['shopping', 'ì‡¼í•‘ Â· íŒ¨ì…˜'],
              ['stay', 'ìˆ™ë°• Â· ì—¬í–‰'],
              ['space', 'ê³µê°„ Â· ìŠ¤íŠœë””ì˜¤'],
              ['academy', 'êµìœ¡ Â· í•™ì›']
            ] 
          %>
          <% categories.each do |cat_code, cat_name| %>
            <button type="submit" name="category" value="<%= cat_code %>" 
                    class="px-5 py-2.5 rounded-xl text-sm font-bold transition-all
                    <%= params[:category] == cat_code || (params[:category].blank? && cat_code == 'all') ? 'bg-slate-900 text-white shadow-md' : 'bg-white text-gray-500 hover:bg-gray-100 border border-gray-100' %>">
              <%= cat_name %>
            </button>
          <% end %>
        </div>

        <!-- Search & Sort -->
        <div class="flex gap-3 w-full xl:w-auto shrink-0">
          <select name="sort" onchange="this.form.submit()" class="bg-white border border-gray-200 rounded-xl text-sm font-bold px-4 py-2.5 cursor-pointer hover:border-gray-300 focus:ring-2 focus:ring-slate-500 outline-none">
            <option value="recommend" <%= 'selected' if params[:sort] == 'recommend' %>>ì¶”ì²œìˆœ</option>
            <option value="latest" <%= 'selected' if params[:sort] == 'latest' %>>ìµœì‹ ìˆœ</option>
            <option value="popular" <%= 'selected' if params[:sort] == 'popular' %>>ì¸ê¸°ìˆœ</option>
          </select>
          <div class="relative w-full lg:w-64">
             <input type="text" name="query" value="<%= params[:query] %>" placeholder="í…œí”Œë¦¿ ê²€ìƒ‰..." class="w-full bg-white border border-gray-200 rounded-xl text-sm px-4 py-2.5 pl-10 focus:ring-2 focus:ring-slate-500 outline-none transition shadow-sm">
             <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          </div>
        </div>
      </form>
    </div>

    <% if @design_templates.blank? %>
      <div class="text-center py-20">
        <div class="text-6xl mb-4">ğŸ˜¢</div>
        <h3 class="text-xl font-bold text-gray-800">ì¡°ê±´ì— ë§ëŠ” í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.</h3>
        <p class="text-gray-500 mt-2">ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ë‚˜ ê²€ìƒ‰ì–´ë¥¼ ì´ìš©í•´ë³´ì„¸ìš”.</p>
        <a href="<%= design_templates_path %>" class="inline-block mt-6 px-6 py-3 bg-slate-900 text-white rounded-lg font-bold">ì „ì²´ ë³´ê¸°</a>
      </div>
    <% else %>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        <% @design_templates.each do |template| %>
          <div class="group bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300 border border-gray-100 flex flex-col h-full transform hover:-translate-y-1">
            
            <!-- Thumbnail (Click to Preview) -->
            <div class="relative aspect-[4/3] bg-gray-100 cursor-pointer overflow-hidden" 
                 onclick="openPreview('<%= template.preview_url %>', '<%= j template.title %>', '<%= template.category %>', <%= template.id %>)">
              
              <% 
                thumb_src = if template.image_url.present?
                              template.image_url
                            elsif template.pc_image.attached?
                              url_for(template.pc_image)
                            else
                              nil
                            end
              %>
              
              <% if thumb_src %>
                <img src="<%= thumb_src %>" alt="<%= template.title %>" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
              <% else %>
                <div class="w-full h-full flex items-center justify-center text-gray-300">
                  <span>No Image</span>
                </div>
              <% end %>

              <!-- Badge -->
              <div class="absolute top-4 left-4">
                <span class="px-3 py-1 bg-white/90 backdrop-blur text-xs font-bold rounded-full uppercase tracking-wider shadow-sm text-slate-800">
                  <%= template.category %>
                </span>
                <% if template.is_featured %>
                  <span class="ml-1 px-3 py-1 bg-amber-400 text-white text-xs font-bold rounded-full uppercase tracking-wider shadow-sm">
                    BEST
                  </span>
                <% end %>
              </div>
              
              <!-- Hover Overlay -->
              <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                <span class="px-6 py-3 bg-white text-slate-900 font-bold rounded-full transform scale-90 group-hover:scale-100 transition-transform">
                  ë¯¸ë¦¬ë³´ê¸°
                </span>
              </div>
            </div>

            <!-- Content -->
            <div class="p-6 flex flex-col flex-grow">
              <h3 class="text-xl font-bold text-slate-900 mb-2 group-hover:text-indigo-600 transition-colors">
                <%= template.title %>
              </h3>
              <p class="text-gray-500 text-sm leading-relaxed line-clamp-2 mb-6 flex-grow">
                <%= template.description %>
              </p>
              
              <!-- Action Buttons -->
              <div class="flex gap-3 mt-auto">
                <button onclick="openPreview('<%= template.preview_url %>', '<%= j template.title %>', '<%= template.category %>', <%= template.id %>)" 
                        class="flex-1 py-3 border-2 border-slate-100 text-slate-600 font-bold rounded-xl hover:bg-slate-50 hover:border-slate-200 transition">
                  ë‘˜ëŸ¬ë³´ê¸°
                </button>
                <%= link_to contact_path(template_id: template.id, preview_url: template.preview_url), 
                            class: "flex-1 py-3 bg-slate-900 text-white font-bold rounded-xl text-center hover:bg-indigo-600 transition shadow-lg shadow-slate-200 flex items-center justify-center gap-2" do %>
                  <span>PICK</span>
                  <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M5 12h14m-7-7l7 7-7 7"/></svg>
                <% end %>
              </div>
            </div>

          </div>
        <% end %>
      </div>

      <style>
        .pagination { display: flex; justify-content: center; align-items: center; gap: 0.5rem; list-style: none; padding: 0; }
        .pagination li { display: inline-flex; }
        .pagination span, .pagination a, .pagination em {
          display: inline-flex; align-items: center; justify-content: center;
          min-width: 2.5rem; height: 2.5rem; padding: 0 0.75rem;
          border-radius: 9999px; font-weight: 500; font-size: 0.875rem;
          background-color: white; border: 1px solid #e2e8f0; color: #64748b;
          text-decoration: none; transition: all 0.2s;
        }
        .pagination a:hover { border-color: #cbd5e1; background-color: #f1f5f9; color: #0f172a; }
        .pagination .current, .pagination em.current {
          background-color: #0f172a; border-color: #0f172a; color: white; pointer-events: none;
        }
        .pagination .disabled, .pagination span.disabled { opacity: 0.5; cursor: not-allowed; background-color: #f8fafc; }
        .pagination .gap { border: none; background: transparent; }
      </style>

      <!-- Pagination -->
      <div class="mt-16 flex justify-center">
        <%= paginate @design_templates %>
      </div>
    <% end %>
  </div>

  <!-- Preview Modal (Simple & Robust) -->
  <div id="preview-modal" class="fixed inset-0 z-[100] hidden" role="dialog" aria-modal="true">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity opacity-0" id="modal-backdrop"></div>
    
    <!-- Modal Content -->
    <div class="absolute inset-0 flex flex-col bg-white w-full h-full md:m-8 md:w-auto md:h-auto md:rounded-2xl overflow-hidden shadow-2xl transition-transform scale-95 opacity-0" id="modal-content">
      
      <!-- Header -->
      <div class="h-16 border-b border-gray-100 flex justify-between items-center px-6 bg-white shrink-0">
        <div class="flex items-center gap-4">
          <h2 id="modal-title" class="font-bold text-lg text-slate-900">Template Title</h2>
          <span id="modal-category" class="px-2 py-1 bg-gray-100 text-gray-500 text-xs font-bold rounded uppercase">CAT</span>
        </div>
        
        <div class="flex items-center gap-4">
          <!-- Device Toggle (Simple) -->
          <div class="hidden md:flex bg-gray-100 p-1 rounded-lg">
            <button onclick="setDevice('pc')" class="p-2 rounded hover:bg-white shadow-sm transition" title="PC View">
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            </button>
            <button onclick="setDevice('mobile')" class="p-2 rounded hover:bg-white shadow-sm transition" title="Mobile View">
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
            </button>
          </div>

          <a id="modal-pick-btn" href="#" class="px-6 py-2 bg-indigo-600 text-white text-sm font-bold rounded-lg hover:bg-indigo-700 transition">
            ì´ í…œí”Œë¦¿ìœ¼ë¡œ ì˜ë¢°
          </a>
          
          <button onclick="closePreview()" class="p-2 text-gray-400 hover:text-gray-600">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
      </div>

      <!-- Iframe Container -->
      <div class="flex-grow bg-gray-50 relative overflow-hidden flex flex-col items-center justify-center w-full">
        <!-- PC Frame -->
        <iframe id="iframe-preview" class="w-full h-full bg-white transition-all duration-500 shadow-sm" src="about:blank"></iframe>
      </div>

    </div>
  </div>

  <script>
    const modal = document.getElementById('preview-modal');
    const backdrop = document.getElementById('modal-backdrop');
    const content = document.getElementById('modal-content');
    const iframe = document.getElementById('iframe-preview');
    const pickBtn = document.getElementById('modal-pick-btn');
    
    let isMobile = false;

    function openPreview(url, title, category, id) {
      console.log("Opening:", url);
      
      // Update Content
      iframe.src = url;
      document.getElementById('modal-title').innerText = title;
      document.getElementById('modal-category').innerText = category;
      pickBtn.href = `/contact?template_id=${id}&preview_url=${encodeURIComponent(url)}`;
      
      // Show Modal
      modal.classList.remove('hidden');
      
      // Trigger Animations
      setTimeout(() => {
        backdrop.classList.remove('opacity-0');
        content.classList.remove('scale-95', 'opacity-0');
      }, 10);
      
      document.body.style.overflow = 'hidden';

      // ESC Key Listener for Iframe (Sequential Closing)
      iframe.onload = () => {
        try {
          const iframeDoc = iframe.contentWindow.document;
          // Focus to capture keys
          iframe.contentWindow.focus();
          
          iframeDoc.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
              // 1. Check for open inner modals inside the template
              // Logic: Find any visible div with "modal" in its ID
              const openInnerModals = Array.from(iframeDoc.querySelectorAll('div[id*="modal"]')).filter(el => {
                const style = window.getComputedStyle(el);
                return !el.classList.contains('hidden') && style.display !== 'none' && style.visibility !== 'hidden';
              });

              // If there's an open inner modal, close it first
              if (openInnerModals.length > 0) {
                e.preventDefault();
                e.stopPropagation();
                
                openInnerModals.forEach(modal => {
                  // Strategy A: Try to find a close button and click it (preserves logic)
                  // Look for buttons with 'X', 'close' text or any button inside if simple
                  const closeBtn = Array.from(modal.querySelectorAll('button')).find(btn => {
                     const text = btn.innerText.trim().toLowerCase();
                     return text === 'x' || text === 'close' || text === 'ë‹«ê¸°' || btn.getAttribute('onclick');
                  });

                  if (closeBtn) {
                    closeBtn.click();
                  } else {
                    // Strategy B: Force close
                    modal.classList.add('hidden');
                  }
                });
              } else {
                // 2. If no inner modal is open, close the main preview
                closePreview();
              }
            }
          });
        } catch(e) { console.warn("Cross-origin iframe access blocked or handler failed"); }
      };
    }

    function closePreview() {
      // Trigger Exit Animations
      backdrop.classList.add('opacity-0');
      content.classList.add('scale-95', 'opacity-0');
      
      setTimeout(() => {
        modal.classList.add('hidden');
        iframe.src = 'about:blank'; // Stop audio/video
        document.body.style.overflow = '';
      }, 300);
    }
    
    // Global ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) closePreview();
    });

    // Device Toggle
    function setDevice(type) {
      if (type === 'mobile') {
         iframe.style.width = '375px';
         iframe.style.borderRadius = '20px';
         iframe.style.margin = '30px auto';
         iframe.style.height = 'calc(100% - 60px)';
         iframe.style.border = '8px solid #333';
         iframe.style.boxSizing = 'border-box';
      } else {
         iframe.style.width = '100%';
         iframe.style.borderRadius = '0';
         iframe.style.margin = '0';
         iframe.style.height = '100%';
         iframe.style.border = 'none';
      }
    }
  </script>

</div>
