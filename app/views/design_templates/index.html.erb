<%# 
  PURE DB-DRIVEN DESIGN TEMPLATES PAGE 
  No hardcoded data. What you see is what's in the DB.
%>

<div class="bg-slate-50 min-h-screen pb-20 font-sans">
  
  <!-- Header Filter Section -->
  <div class="bg-white border-b border-gray-200 sticky top-16 z-30 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 md:px-6 py-4">
      <form action="<%= design_templates_path %>" method="get" class="flex flex-col md:flex-row gap-4 items-center justify-between">
        
        <!-- Category Filter -->
        <div class="flex gap-2 overflow-x-auto w-full md:w-auto pb-2 md:pb-0 no-scrollbar">
          <% categories = ['all', 'beauty', 'dining', 'corporate', 'medical', 'fitness', 'shopping', 'space', 'stay', 'portfolio', 'law', 'cafe', 'academy'] %>
          <% categories.each do |cat| %>
            <button type="submit" name="category" value="<%= cat %>" 
                    class="px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors
                    <%= params[:category] == cat || (params[:category].blank? && cat == 'all') ? 'bg-slate-900 text-white' : 'bg-gray-100 text-gray-500 hover:bg-gray-200' %>">
              <%= cat == 'all' ? 'ALL' : cat.upcase %>
            </button>
          <% end %>
        </div>

        <!-- Sort & Search -->
        <div class="flex gap-2 w-full md:w-auto">
          <select name="sort" onchange="this.form.submit()" class="bg-gray-100 border-none rounded-lg text-sm font-bold px-4 py-2 cursor-pointer focus:ring-2 focus:ring-slate-500">
            <option value="recommend" <%= 'selected' if params[:sort] == 'recommend' %>>Ï∂îÏ≤úÏàú</option>
            <option value="latest" <%= 'selected' if params[:sort] == 'latest' %>>ÏµúÏã†Ïàú</option>
            <option value="popular" <%= 'selected' if params[:sort] == 'popular' %>>Ïù∏Í∏∞Ïàú</option>
          </select>
          <input type="text" name="query" value="<%= params[:query] %>" placeholder="Í≤ÄÏÉâ..." class="bg-gray-100 border-none rounded-lg text-sm px-4 py-2 w-full md:w-48 focus:ring-2 focus:ring-slate-500">
        </div>
      </form>
    </div>
  </div>

  <!-- Main Grid -->
  <div class="max-w-7xl mx-auto px-4 md:px-6 py-12">
    
    <% if @design_templates.blank? %>
      <div class="text-center py-20">
        <div class="text-6xl mb-4">üò¢</div>
        <h3 class="text-xl font-bold text-gray-800">Ï°∞Í±¥Ïóê ÎßûÎäî ÌÖúÌîåÎ¶øÏù¥ ÏóÜÏäµÎãàÎã§.</h3>
        <p class="text-gray-500 mt-2">Îã§Î•∏ Ïπ¥ÌÖåÍ≥†Î¶¨ÎÇò Í≤ÄÏÉâÏñ¥Î•º Ïù¥Ïö©Ìï¥Î≥¥ÏÑ∏Ïöî.</p>
        <a href="<%= design_templates_path %>" class="inline-block mt-6 px-6 py-3 bg-slate-900 text-white rounded-lg font-bold">Ï†ÑÏ≤¥ Î≥¥Í∏∞</a>
      </div>
    <% else %>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        <% @design_templates.each do |template| %>
          <div class="group bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300 border border-gray-100 flex flex-col h-full transform hover:-translate-y-1">
            
            <!-- Thumbnail (Click to Preview) -->
            <div class="relative aspect-[4/3] bg-gray-100 cursor-pointer overflow-hidden" 
                 onclick="openPreview('<%= template.preview_url %>', '<%= j template.title %>', '<%= template.category %>', <%= template.id %>)">
              
              <% if template.image_url.present? %>
                <img src="<%= template.image_url %>" alt="<%= template.title %>" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
              <% else %>
                <div class="w-full h-full flex items-center justify-center text-gray-300">
                  <span>No Image</span>
                </div>
              <% end %>

              <!-- Badge -->
              <div class="absolute top-4 left-4">
                <span class="px-3 py-1 bg-white/90 backdrop-blur text-xs font-bold rounded-full uppercase tracking-wider shadow-sm text-slate-800">
                  <%= template.category %>
                </span>
                <% if template.is_featured %>
                  <span class="ml-1 px-3 py-1 bg-amber-400 text-white text-xs font-bold rounded-full uppercase tracking-wider shadow-sm">
                    BEST
                  </span>
                <% end %>
              </div>
              
              <!-- Hover Overlay -->
              <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                <span class="px-6 py-3 bg-white text-slate-900 font-bold rounded-full transform scale-90 group-hover:scale-100 transition-transform">
                  ÎØ∏Î¶¨Î≥¥Í∏∞
                </span>
              </div>
            </div>

            <!-- Content -->
            <div class="p-6 flex flex-col flex-grow">
              <h3 class="text-xl font-bold text-slate-900 mb-2 group-hover:text-indigo-600 transition-colors">
                <%= template.title %>
              </h3>
              <p class="text-gray-500 text-sm leading-relaxed line-clamp-2 mb-6 flex-grow">
                <%= template.description %>
              </p>
              
              <!-- Action Buttons -->
              <div class="flex gap-3 mt-auto">
                <button onclick="openPreview('<%= template.preview_url %>', '<%= j template.title %>', '<%= template.category %>', <%= template.id %>)" 
                        class="flex-1 py-3 border-2 border-slate-100 text-slate-600 font-bold rounded-xl hover:bg-slate-50 hover:border-slate-200 transition">
                  ÎëòÎü¨Î≥¥Í∏∞
                </button>
                <%= link_to contact_path(template_id: template.id, preview_url: template.preview_url), 
                            class: "flex-1 py-3 bg-slate-900 text-white font-bold rounded-xl text-center hover:bg-indigo-600 transition shadow-lg shadow-slate-200 flex items-center justify-center gap-2" do %>
                  <span>PICK</span>
                  <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M5 12h14m-7-7l7 7-7 7"/></svg>
                <% end %>
              </div>
            </div>

          </div>
        <% end %>
      </div>

      <!-- Pagination -->
      <div class="mt-16 flex justify-center">
        <%= paginate @design_templates %>
      </div>
    <% end %>
  </div>

  <!-- Preview Modal (Simple & Robust) -->
  <div id="preview-modal" class="fixed inset-0 z-[100] hidden" role="dialog" aria-modal="true">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity opacity-0" id="modal-backdrop"></div>
    
    <!-- Modal Content -->
    <div class="absolute inset-0 flex flex-col bg-white w-full h-full md:m-8 md:w-auto md:h-auto md:rounded-2xl overflow-hidden shadow-2xl transition-transform scale-95 opacity-0" id="modal-content">
      
      <!-- Header -->
      <div class="h-16 border-b border-gray-100 flex justify-between items-center px-6 bg-white shrink-0">
        <div class="flex items-center gap-4">
          <h2 id="modal-title" class="font-bold text-lg text-slate-900">Template Title</h2>
          <span id="modal-category" class="px-2 py-1 bg-gray-100 text-gray-500 text-xs font-bold rounded uppercase">CAT</span>
        </div>
        
        <div class="flex items-center gap-4">
          <!-- Device Toggle (Simple) -->
          <div class="hidden md:flex bg-gray-100 p-1 rounded-lg">
            <button onclick="setDevice('pc')" class="p-2 rounded hover:bg-white shadow-sm transition" title="PC View">
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            </button>
            <button onclick="setDevice('mobile')" class="p-2 rounded hover:bg-white shadow-sm transition" title="Mobile View">
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
            </button>
          </div>

          <a id="modal-pick-btn" href="#" class="px-6 py-2 bg-indigo-600 text-white text-sm font-bold rounded-lg hover:bg-indigo-700 transition">
            Ïù¥ ÌÖúÌîåÎ¶øÏúºÎ°ú ÏùòÎ¢∞
          </a>
          
          <button onclick="closePreview()" class="p-2 text-gray-400 hover:text-gray-600">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
      </div>

      <!-- Iframe Container -->
      <div class="flex-grow bg-gray-50 relative overflow-hidden flex justify-center w-full">
        <!-- PC Frame -->
        <iframe id="iframe-preview" class="w-full h-full bg-white transition-all duration-500 shadow-sm" src="about:blank"></iframe>
      </div>

    </div>
  </div>

  <script>
    const modal = document.getElementById('preview-modal');
    const backdrop = document.getElementById('modal-backdrop');
    const content = document.getElementById('modal-content');
    const iframe = document.getElementById('iframe-preview');
    const pickBtn = document.getElementById('modal-pick-btn');
    
    let isMobile = false;

    function openPreview(url, title, category, id) {
      console.log("Opening:", url);
      
      // Update Content
      iframe.src = url;
      document.getElementById('modal-title').innerText = title;
      document.getElementById('modal-category').innerText = category;
      pickBtn.href = `/contact?template_id=${id}&preview_url=${encodeURIComponent(url)}`;
      
      // Show Modal
      modal.classList.remove('hidden');
      
      // Trigger Animations
      setTimeout(() => {
        backdrop.classList.remove('opacity-0');
        content.classList.remove('scale-95', 'opacity-0');
      }, 10);
      
      document.body.style.overflow = 'hidden';

      // ESC Key Listener for Iframe
      iframe.onload = () => {
        try {
          // Focus to capture keys
          iframe.contentWindow.focus();
          iframe.contentWindow.document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closePreview();
          });
        } catch(e) { console.warn("Cross-origin iframe access blocked"); }
      };
    }

    function closePreview() {
      // Trigger Exit Animations
      backdrop.classList.add('opacity-0');
      content.classList.add('scale-95', 'opacity-0');
      
      setTimeout(() => {
        modal.classList.add('hidden');
        iframe.src = 'about:blank'; // Stop audio/video
        document.body.style.overflow = '';
      }, 300);
    }
    
    // Global ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) closePreview();
    });

    // Device Toggle
    function setDevice(type) {
      if (type === 'mobile') {
         iframe.style.width = '375px';
         iframe.style.borderRadius = '24px';
         iframe.style.margin = '20px auto';
         iframe.style.height = 'calc(100% - 40px)';
         iframe.style.border = '8px solid #333';
      } else {
         iframe.style.width = '100%';
         iframe.style.borderRadius = '0';
         iframe.style.margin = '0';
         iframe.style.height = '100%';
         iframe.style.border = 'none';
      }
    }
  </script>

</div>
